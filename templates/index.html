<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <title>Generador de C√≥digo de Barras</title>
</head>
<body>
    <div id="loadingScreen" style="display: none;">
        <div class="spinner"></div>
        <p>BUSCANDO...</p>
    </div>    
    <div id="container">
        <img src="{{ url_for('static', filename='imagenes/logo-globaltec.png') }}" alt="Logo Globaltec" class="header-image">
       
        <!-- Secci√≥n inicial de b√∫squeda -->
        <div id="searchSection" style="display: block;">
            <div class="input-container">
                <label for="codeInput" class="label-codeInput">CODIGO<br>SAP</label>
                <input type="text" id="codeInput" placeholder="Ingresa el c√≥digo" aria-label="C√≥digo SAP">
                <button id="searchButton" onclick="searchCode()">BUSCAR</button>
            </div>
        </div>
 
        <!-- Secci√≥n de resultados (inicialmente oculta) -->
        <div id="resultSection" style="display: none;">
            <div class="result-container">
                <div class="code-display">
                    <label>CODIGO<br>SAP</label>
                    <span id="codeDisplay"></span>
                </div>
 
                <div class="quantity-input">
                    <label for="quantityInput">CANTIDAD</label>
                    <input type="number" id="quantityInput" min="1" value="1">
                </div>
 
                <!--<div class="description-display">
                    <label>DESCRIPCI√ìN:</label>
                    <p id="descriptionDisplay"></p>
                </div>-->
 
                <button id="btnConnect">Conectar Impresora</button>
 
                <div class="button-container">
                    <button onclick="imprimirPDF()">IMPRIMIR</button>
                </div>
 
                <button onclick="printTest()">Imprimir</button>
 
                <div id="backButtonContainer">
                    <button onclick="goBack()">REGRESAR</button>
                </div>
            </div>
        </div>
 
        <p id="errorMessage" class="error-message" role="alert"></p>
        <p id="successMessage" class="success-message" role="status"></p>
    </div>
 
    <script>
        // Verificar si el navegador soporta la Web Bluetooth API
        if (!navigator.bluetooth) {
            alert("El navegador no soporta la Web Bluetooth API.");
        }
 
        // Funci√≥n para conectar a un dispositivo Bluetooth seleccionado
        function connectBluetooth() {
            const selectedDevice = document.getElementById('printerSelect').value;
 
            if (!selectedDevice) {
                alert("Por favor, selecciona un dispositivo Bluetooth.");
                return;
            }
 
            // Encontrar el dispositivo y conectar
            navigator.bluetooth.requestDevice({
                acceptAllDevices: true, // Aceptar todos los dispositivos disponibles
                optionalServices: ['printer'] // Filtro para buscar impresoras
            })
            .then(device => {
                if (device.name === selectedDevice) {
                    return device.gatt.connect();
                } else {
                    throw new Error('El dispositivo seleccionado no coincide.');
                }
            })
            .then(server => {
                console.log("Conectado al dispositivo:", server);
                alert("Conexi√≥n exitosa con el dispositivo Bluetooth.");
            })
            .catch(error => {
                console.error("Error al conectar al dispositivo Bluetooth: ", error);
                alert("No se pudo conectar al dispositivo Bluetooth.");
            });
        }
 
        // Funci√≥n de b√∫squeda del c√≥digo
        function searchCode() {
            const code = document.getElementById('codeInput').value;
            document.getElementById('loadingScreen').style.display = 'flex'; // Mostrar pantalla de carga
            fetch(`/buscar?codigo=${code}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingScreen').style.display = 'none'; // Ocultar pantalla de carga
                    if (data.error) {
                        document.getElementById('errorMessage').textContent = data.error;
                        document.getElementById('resultSection').style.display = 'none';
                    } else {
                        document.getElementById('codeDisplay').textContent = data.code;
                        document.getElementById('descriptionDisplay').textContent = data.description;
                        document.getElementById('resultSection').style.display = 'block';
                        document.getElementById('errorMessage').textContent = '';
 
                        // Guardar marca y medida en variables ocultas
                        document.getElementById('codeDisplay').dataset.marca = data.marca;
                        document.getElementById('codeDisplay').dataset.medida = data.medida;
 
                        // Ocultar el bot√≥n de b√∫squeda y el contenedor de entrada
                        document.getElementById('searchButton').style.display = 'none';
                        document.querySelector('.input-container').style.display = 'none';
                    }
                })
                .catch(error => {
                    document.getElementById('loadingScreen').style.display = 'none'; // Ocultar pantalla de carga
                    document.getElementById('errorMessage').textContent = 'Error al buscar el c√≥digo.';
                    document.getElementById('resultSection').style.display = 'none';
                });
        }
 
        // Funci√≥n para regresar a la pantalla de b√∫squeda
        function goBack() {
            // Ocultar la secci√≥n de resultados
            document.getElementById('resultSection').style.display = 'none';
 
            // Mostrar la secci√≥n de b√∫squeda
            const searchSection = document.getElementById('searchSection');
            searchSection.style.display = 'flex';
            searchSection.style.flexDirection = 'column';
            searchSection.style.alignItems = 'center';
            searchSection.style.justifyContent = 'center';
 
            // Restaurar cualquier estilo del contenedor principal
            const container = document.getElementById('container');
            container.style.flexDirection = 'column';
            container.style.alignItems = 'center';
            container.style.justifyContent = 'center';
 
            // Limpiar mensajes y campos
            document.getElementById('codeInput').value = '';
            document.getElementById('errorMessage').textContent = '';
            document.getElementById('successMessage').textContent = '';
 
            // Mostrar bot√≥n de b√∫squeda
            document.getElementById('searchButton').style.display = 'inline-block';
            document.querySelector('.input-container').style.display = 'flex';
        }
 
        let printerCharacteristic = null; // Variable global para almacenar la caracter√≠stica de escritura
 
        async function connectPrinter() {
            try {
                console.log("üîç Buscando impresora...");
 
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ["000018f0-0000-1000-8000-00805f9b34fb"] // UUID del servicio XPrinter
                });
 
                console.log("üì° Dispositivo seleccionado:", device.name);
 
                const server = await device.gatt.connect();
                console.log("‚úÖ Conectado a:", device.name);
 
                const service = await server.getPrimaryService("000018f0-0000-1000-8000-00805f9b34fb");
                console.log("üîç Servicio obtenido:", service);
 
                printerCharacteristic = await service.getCharacteristic("00002af1-0000-1000-8000-00805f9b34fb");
                console.log("üìù Caracter√≠stica de escritura lista:", printerCharacteristic.uuid);
 
                alert("¬°Impresora conectada!");
 
            } catch (error) {
                console.error("‚ùå Error al conectar la impresora:", error);
                alert("Error al conectar la impresora. Revisa la consola.");
            }
        }
 
        async function printTest() {
            if (!printerCharacteristic) {
                alert("Primero debes conectar la impresora.");
                return;
            }
 
            try {
                const printCommand = new Uint8Array([
                    0x1B, 0x40, // Inicializar
                    0x1B, 0x21, 0x00, // Tama√±o de fuente normal
                    0x48, 0x6F, 0x6C, 0x61, 0x20, 0x4D, 0x75, 0x6E, 0x64, 0x6F, // "Hola Mundo"
                    0x0A, 0x0A, 0x0A, // Saltos de l√≠nea
                    0x1D, 0x56, 0x41, 0x03 // Corte de papel
                ]);
 
                await printerCharacteristic.writeValue(printCommand);
                console.log("üñ®Ô∏è Impresi√≥n enviada con ESC/POS");
                alert("¬°Impresi√≥n enviada!");
 
            } catch (error) {
                console.error("‚ùå Error de impresi√≥n:", error);
                alert("Error al enviar la impresi√≥n.");
            }
        }
 
        // Vincular los botones
        document.getElementById("btnConnect").addEventListener("click", connectPrinter);
        document.getElementById("btnPrint").addEventListener("click", printTest);
 
        // Funci√≥n para imprimir PDF
        function imprimirPDF() {
            const code = document.getElementById('codeDisplay').textContent;
            const quantity = document.getElementById('quantityInput').value;
            const description = document.getElementById('descriptionDisplay').textContent;
            const marca = document.getElementById('codeDisplay').dataset.marca;
            const medida = document.getElementById('codeDisplay').dataset.medida;
 
            fetch('/generar_pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    quantity: quantity,
                    description: description,
                    marca: marca,
                    medida: medida
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const reader = new FileReader();
                reader.onload = function() {
                    const pdfData = reader.result.split(',')[1];
                    const printerName = document.getElementById('printerSelect').value;
                    if (!printerName) {
                        alert("Por favor, selecciona una impresora.");
                        return;
                    }
                    const config = qz.configs.create(printerName); // Usamos el nombre de la impresora seleccionada
                    const data = [{
                        type: 'pdf',
                        format: 'base64',
                        data: pdfData
                    }];
                    qz.print(config, data).then(function() {
                        console.log("Impresi√≥n completada.");
                        alert("El archivo se envi√≥ correctamente a la impresora.");
                    }).catch(function(error) {
                        console.error("Error al imprimir el PDF: ", error);
                        alert("Error al enviar el archivo a la impresora.");
                    });
                };
                reader.readAsDataURL(blob);
            })
            .catch(error => {
                console.error("Error al generar el PDF: ", error);
                alert("No se pudo generar el PDF en el servidor.");
            });
        }
    </script>
</body>
</html>







